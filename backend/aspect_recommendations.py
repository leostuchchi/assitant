import logging
from typing import Dict, List, Any
import random

logger = logging.getLogger(__name__)


class AspectRecommendationEngine:
    """
    –ü—Ä–æ—Å—Ç–æ–π –¥–≤–∏–∂–æ–∫ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –∞—Å–ø–µ–∫—Ç–æ–≤
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —à–∞–±–ª–æ–Ω—ã –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ–Ω—è—Ç–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
    """

    def __init__(self):
        # –®–∞–±–ª–æ–Ω—ã —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –ø–æ —Ç–∏–ø–∞–º –∞—Å–ø–µ–∫—Ç–æ–≤
        self.aspect_templates = {
            'conjunction': {
                'positive': [
                    "–≠–Ω–µ—Ä–≥–∏—è {transit} –∏ {natal} –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç—Å—è - –∏–¥–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤",
                    "–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ {transit} —Å {natal} –¥–∞–µ—Ç –º–æ—â–Ω—ã–π –∏–º–ø—É–ª—å—Å –¥–ª—è –¥–µ–π—Å—Ç–≤–∏–π",
                    "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—É—é —ç–Ω–µ—Ä–≥–∏—é {transit} –∏ {natal} –¥–ª—è —Ä–µ—à–∏—Ç–µ–ª—å–Ω—ã—Ö —à–∞–≥–æ–≤"
                ],
                'challenge': [
                    "–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ {transit} –∏ {natal} –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ - –±—É–¥—å—Ç–µ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω—ã –≤ –æ–±—â–µ–Ω–∏–∏",
                    "–≠–Ω–µ—Ä–≥–∏—è –∞—Å–ø–µ–∫—Ç–∞ –æ—á–µ–Ω—å –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è - –∏–∑–±–µ–≥–∞–π—Ç–µ –ø–æ—Å–ø–µ—à–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π",
                    "–°—Ñ–æ–∫—É—Å–∏—Ä—É–π—Ç–µ –º–æ—â–Ω—É—é —ç–Ω–µ—Ä–≥–∏—é —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –Ω–∞ –æ–¥–Ω–æ–π –≤–∞–∂–Ω–æ–π –∑–∞–¥–∞—á–µ"
                ]
            },
            'opposition': {
                'positive': [
                    "–û–ø–ø–æ–∑–∏—Ü–∏—è {transit} –∏ {natal} –ø–æ–º–æ–≥–∞–µ—Ç —É–≤–∏–¥–µ—Ç—å —Ä–∞–∑–Ω—ã–µ —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è",
                    "–ò–¥–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –ø–µ—Ä–µ–≥–æ–≤–æ—Ä–æ–≤ –∏ –ø–æ–∏—Å–∫–∞ –∫–æ–º–ø—Ä–æ–º–∏—Å—Å–æ–≤",
                    "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–æ—Ç–∏–≤–æ—Å—Ç–æ—è–Ω–∏–µ —ç–Ω–µ—Ä–≥–∏–π –¥–ª—è –±–∞–ª–∞–Ω—Å–∞ –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö"
                ],
                'challenge': [
                    "–û–ø–ø–æ–∑–∏—Ü–∏—è {transit}-{natal} –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã - –ø—Ä–æ—è–≤–ª—è–π—Ç–µ –≥–∏–±–∫–æ—Å—Ç—å",
                    "–í–æ–∑–º–æ–∂–Ω—ã –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è - –∏—â–∏—Ç–µ –∑–æ–ª–æ—Ç—É—é —Å–µ—Ä–µ–¥–∏–Ω—É",
                    "–ò–∑–±–µ–≥–∞–π—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—á–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π –ø—Ä–∏ —ç—Ç–æ–º –∞—Å–ø–µ–∫—Ç–µ"
                ]
            },
            'square': {
                'positive': [
                    "–ö–≤–∞–¥—Ä–∞—Ç {transit} –∏ {natal} –¥–∞–µ—Ç —ç–Ω–µ—Ä–≥–∏—é –¥–ª—è –ø—Ä–µ–æ–¥–æ–ª–µ–Ω–∏—è –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π",
                    "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ –∞—Å–ø–µ–∫—Ç–∞ –¥–ª—è –º–æ–±–∏–ª–∏–∑–∞—Ü–∏–∏ —Å–∏–ª",
                    "–≠—Ç–æ –≤—Ä–µ–º—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –∏ —Ä–µ—à–µ–Ω–∏—è –Ω–∞–∫–æ–ø–∏–≤—à–∏—Ö—Å—è –ø—Ä–æ–±–ª–µ–º"
                ],
                'challenge': [
                    "–ö–≤–∞–¥—Ä–∞—Ç—É—Ä–∞ {transit}-{natal} —Ç—Ä–µ–±—É–µ—Ç –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç–∏ –≤ –¥–µ–π—Å—Ç–≤–∏—è—Ö",
                    "–í–æ–∑–º–æ–∂–Ω—ã –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω—ã–µ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ - –∏–º–µ–π—Ç–µ –∑–∞–ø–∞—Å–Ω–æ–π –ø–ª–∞–Ω",
                    "–ò–∑–±–µ–≥–∞–π—Ç–µ –∫–æ–Ω—Ñ—Ä–æ–Ω—Ç–∞—Ü–∏–∏, —Ä–µ—à–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å—ã –¥–∏–ø–ª–æ–º–∞—Ç–∏—á–Ω–æ"
                ]
            },
            'trine': {
                'positive': [
                    "–¢—Ä–∏–Ω {transit} –∏ {natal} –ø—Ä–∏–Ω–æ—Å–∏—Ç –≥–∞—Ä–º–æ–Ω–∏—é –∏ —É–¥–∞—á–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏",
                    "–ë–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–∞ –∏ —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–∞",
                    "–≠–Ω–µ—Ä–≥–∏—è —Ç–µ—á–µ—Ç –ª–µ–≥–∫–æ - –¥–æ–≤–µ—Ä—è–π—Ç–µ –∏–Ω—Ç—É–∏—Ü–∏–∏ –∏ –¥–µ–π—Å—Ç–≤—É–π—Ç–µ"
                ],
                'challenge': [
                    "–ü—Ä–∏ –ª–µ–≥–∫–æ–π —ç–Ω–µ—Ä–≥–∏–∏ —Ç—Ä–∏–Ω–∞ –≤–∞–∂–Ω–æ –Ω–µ —É–ø—É—Å–∫–∞—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏",
                    "–ù–µ —Ä–∞—Å—Å–ª–∞–±–ª—è–π—Ç–µ—Å—å —Å–ª–∏—à–∫–æ–º - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω—ã–π –ø–µ—Ä–∏–æ–¥",
                    "–°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å, –¥–∞–∂–µ –∫–æ–≥–¥–∞ –≤—Å–µ –¥–∞–µ—Ç—Å—è –ª–µ–≥–∫–æ"
                ]
            },
            'sextile': {
                'positive': [
                    "–°–µ–∫—Å—Ç–∏–ª—å {transit} –∏ {natal} –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –Ω–æ–≤—ã–µ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã",
                    "–ò–¥–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–ª–µ–∑–Ω—ã—Ö —Å–≤—è–∑–µ–π",
                    "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–ª—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ —Ä–æ—Å—Ç–∞"
                ],
                'challenge': [
                    "–ü—Ä–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π –≤–∞–∂–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–∞—Å—Å—Ç–∞–≤–∏—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã",
                    "–ù–µ —Ä–∞—Å–ø—ã–ª—è–π—Ç–µ—Å—å - –≤—ã–±–µ—Ä–∏—Ç–µ —Å–∞–º—ã–µ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–Ω—ã–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è",
                    "–£–¥–µ–ª–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—é –Ω–∞ –±—É–¥—É—â–µ–µ"
                ]
            }
        }

        # –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –ø–ª–∞–Ω–µ—Ç–∞–º
        self.planet_recommendations = {
            'Sun': {
                'focus': "–ª–∏—á–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è, —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å, —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ",
                'action': "–ø—Ä–æ—è–≤–ª—è–π—Ç–µ –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—É, –±—É–¥—å—Ç–µ –≤ —Ü–µ–Ω—Ç—Ä–µ –≤–Ω–∏–º–∞–Ω–∏—è"
            },
            'Moon': {
                'focus': "—ç–º–æ—Ü–∏–∏, –∏–Ω—Ç—É–∏—Ü–∏—è, –¥–æ–º–∞—à–Ω–∏–µ –¥–µ–ª–∞",
                'action': "–ø—Ä–∏—Å–ª—É—à–∏–≤–∞–π—Ç–µ—Å—å –∫ —á—É–≤—Å—Ç–≤–∞–º, –∑–∞–±–æ—Ç—å—Ç–µ—Å—å –æ –∫–æ–º—Ñ–æ—Ä—Ç–µ"
            },
            'Mercury': {
                'focus': "–æ–±—â–µ–Ω–∏–µ, –æ–±—É—á–µ–Ω–∏–µ, –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è",
                'action': "—É—á–∏—Ç–µ—Å—å, –¥–æ–≥–æ–≤–∞—Ä–∏–≤–∞–π—Ç–µ—Å—å, –ø–ª–∞–Ω–∏—Ä—É–π—Ç–µ"
            },
            'Venus': {
                'focus': "–æ—Ç–Ω–æ—à–µ–Ω–∏—è, –∫—Ä–∞—Å–æ—Ç–∞, —Ñ–∏–Ω–∞–Ω—Å—ã",
                'action': "—É–∫—Ä–µ–ø–ª—è–π—Ç–µ —Å–≤—è–∑–∏, —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ –≥–∞—Ä–º–æ–Ω–∏—é"
            },
            'Mars': {
                'focus': "–¥–µ–π—Å—Ç–≤–∏—è, —ç–Ω–µ—Ä–≥–∏—è, –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è",
                'action': "–±—É–¥—å—Ç–µ –∞–∫—Ç–∏–≤–Ω—ã, —Ä–µ—à–∞–π—Ç–µ –∑–∞–¥–∞—á–∏"
            },
            'Jupiter': {
                'focus': "—Ä–æ—Å—Ç, –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏, –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è",
                'action': "—Ä–∞—Å—à–∏—Ä—è–π—Ç–µ –≥–æ—Ä–∏–∑–æ–Ω—Ç—ã, —É—á–∏—Ç–µ—Å—å –Ω–æ–≤–æ–º—É"
            },
            'Saturn': {
                'focus': "–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å, —Å—Ç—Ä—É–∫—Ç—É—Ä–∞, –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞",
                'action': "–ø–ª–∞–Ω–∏—Ä—É–π—Ç–µ, –æ—Ä–≥–∞–Ω–∏–∑—É–π—Ç–µ, –∑–∞–≤–µ—Ä—à–∞–π—Ç–µ –¥–µ–ª–∞"
            },
            'Uranus': {
                'focus': "–∏–∑–º–µ–Ω–µ–Ω–∏—è, –∏–Ω–Ω–æ–≤–∞—Ü–∏–∏, —Å–≤–æ–±–æ–¥–∞",
                'action': "–±—É–¥—å—Ç–µ –≥–∏–±–∫–∏–º–∏, —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ"
            },
            'Neptune': {
                'focus': "–∏–Ω—Ç—É–∏—Ü–∏—è, —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ, –¥—É—Ö–æ–≤–Ω–æ—Å—Ç—å",
                'action': "–º–µ—á—Ç–∞–π—Ç–µ, —Ç–≤–æ—Ä–∏—Ç–µ, –¥–æ–≤–µ—Ä—è–π—Ç–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–º—É –≥–æ–ª–æ—Å—É"
            },
            'Pluto': {
                'focus': "—Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è, –≥–ª—É–±–∏–Ω–∞, –≤–ª–∞—Å—Ç—å",
                'action': "–∏–∑–±–∞–≤–ª—è–π—Ç–µ—Å—å –æ—Ç —Å—Ç–∞—Ä–æ–≥–æ, –æ–±–Ω–æ–≤–ª—è–π—Ç–µ—Å—å"
            }
        }

        # –†—É—Å—Å–∫–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è –ø–ª–∞–Ω–µ—Ç
        self.planet_names_ru = {
            'Sun': '–°–æ–ª–Ω—Ü–∞', 'Moon': '–õ—É–Ω—ã', 'Mercury': '–ú–µ—Ä–∫—É—Ä–∏—è',
            'Venus': '–í–µ–Ω–µ—Ä—ã', 'Mars': '–ú–∞—Ä—Å–∞', 'Jupiter': '–Æ–ø–∏—Ç–µ—Ä–∞',
            'Saturn': '–°–∞—Ç—É—Ä–Ω–∞', 'Uranus': '–£—Ä–∞–Ω–∞', 'Neptune': '–ù–µ–ø—Ç—É–Ω–∞',
            'Pluto': '–ü–ª—É—Ç–æ–Ω–∞', 'North_Node': '–°–µ–≤–µ—Ä–Ω–æ–≥–æ –£–∑–ª–∞',
            'Ascendant': '–ê—Å—Ü–µ–Ω–¥–µ–Ω—Ç–∞', 'Midheaven': '–°–µ—Ä–µ–¥–∏–Ω—ã –ù–µ–±–∞'
        }

    def generate_aspect_recommendations(self, aspects_data: List[Dict]) -> List[str]:
        """
        –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ—Å—Ç—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞—Å–ø–µ–∫—Ç–æ–≤
        """
        recommendations = []

        try:
            # –°–æ—Ä—Ç–∏—Ä—É–µ–º –∞—Å–ø–µ–∫—Ç—ã –ø–æ —Å–∏–ª–µ (—Å–∞–º—ã–µ —Å–∏–ª—å–Ω—ã–µ –ø–µ—Ä–≤—ã–µ)
            strong_aspects = [a for a in aspects_data if a.get('strength', 0) > 0.7]
            sorted_aspects = sorted(strong_aspects, key=lambda x: x.get('strength', 0), reverse=True)

            # –ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ —Ç–æ–ø-3 —Å–∞–º—ã—Ö —Å–∏–ª—å–Ω—ã—Ö –∞—Å–ø–µ–∫—Ç–∞
            for aspect in sorted_aspects[:3]:
                rec = self._generate_single_aspect_recommendation(aspect)
                if rec:
                    recommendations.append(rec)

            # –ï—Å–ª–∏ —Å–∏–ª—å–Ω—ã—Ö –∞—Å–ø–µ–∫—Ç–æ–≤ –º–∞–ª–æ, –¥–æ–±–∞–≤–ª—è–µ–º –æ–±—â–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
            if len(recommendations) < 2:
                general_recs = self._get_general_recommendations(aspects_data)
                recommendations.extend(general_recs[:2])

        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –∞—Å–ø–µ–∫—Ç–æ–≤: {e}")
            recommendations = ["–°–µ–≥–æ–¥–Ω—è —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Ñ–æ–Ω - —Ö–æ—Ä–æ—à–µ–µ –≤—Ä–µ–º—è –¥–ª—è –ø–ª–∞–Ω–æ–≤—ã—Ö –¥–µ–ª"]

        return recommendations

    def _generate_single_aspect_recommendation(self, aspect: Dict) -> str:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –æ–¥–Ω–æ–≥–æ –∞—Å–ø–µ–∫—Ç–∞"""
        try:
            transit_planet = aspect.get('transit_planet', '')
            natal_planet = aspect.get('natal_planet', '')
            aspect_type = aspect.get('aspect', '')
            strength = aspect.get('strength', 0)

            if not all([transit_planet, natal_planet, aspect_type]):
                return None

            # –ü–æ–ª—É—á–∞–µ–º —Ä—É—Å—Å–∫–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è –ø–ª–∞–Ω–µ—Ç
            transit_ru = self.planet_names_ru.get(transit_planet, transit_planet)
            natal_ru = self.planet_names_ru.get(natal_planet, natal_planet)

            # –í—ã–±–∏—Ä–∞–µ–º —Ç–∏–ø —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (–ø–æ–∑–∏—Ç–∏–≤–Ω–∞—è –∏–ª–∏ –≤—ã–∑–æ–≤)
            rec_type = 'positive' if strength > 0.8 else 'challenge'

            # –ü–æ–ª—É—á–∞–µ–º —à–∞–±–ª–æ–Ω—ã –¥–ª—è —ç—Ç–æ–≥–æ —Ç–∏–ø–∞ –∞—Å–ø–µ–∫—Ç–∞
            templates = self.aspect_templates.get(aspect_type, {}).get(rec_type, [])

            if templates:
                template = random.choice(templates)
                recommendation = template.format(transit=transit_ru, natal=natal_ru)

                # –î–æ–±–∞–≤–ª—è–µ–º —ç–º–æ–¥–∑–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –∞—Å–ø–µ–∫—Ç–∞
                emoji_map = {
                    'conjunction': '‚ö°', 'opposition': '‚öñÔ∏è',
                    'square': 'üéØ', 'trine': 'üåü', 'sextile': 'üí´'
                }
                emoji = emoji_map.get(aspect_type, '‚ú®')

                return f"{emoji} {recommendation}"

        except Exception as e:
            logger.warning(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –∞—Å–ø–µ–∫—Ç–∞: {e}")

        return None

    def _get_general_recommendations(self, aspects_data: List[Dict]) -> List[str]:
        """–û–±—â–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ–±—â–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –∞—Å–ø–µ–∫—Ç–æ–≤"""
        general_recs = []

        try:
            total_aspects = len(aspects_data)
            strong_aspects = len([a for a in aspects_data if a.get('strength', 0) > 0.7])

            # –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∞—Å–ø–µ–∫—Ç–æ–≤
            if total_aspects == 0:
                general_recs.append("üåô –°–µ–≥–æ–¥–Ω—è —Å–ø–æ–∫–æ–π–Ω—ã–π –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Ñ–æ–Ω - —Ö–æ—Ä–æ—à–µ–µ –≤—Ä–µ–º—è –¥–ª—è –æ—Ç–¥—ã—Ö–∞ –∏ —Ä—É—Ç–∏–Ω–Ω—ã—Ö –¥–µ–ª")
            elif total_aspects <= 3:
                general_recs.append("‚öñÔ∏è –ù–µ–±–æ–ª—å—à–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞—Å–ø–µ–∫—Ç–æ–≤ - –¥–µ–Ω—å –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è —Ä–∞–∑–º–µ—Ä–µ–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã")
            elif total_aspects > 8:
                general_recs.append("üéØ –ú–Ω–æ–≥–æ –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –≤–ª–∏—è–Ω–∏–π - –±—É–¥—å—Ç–µ –≥–æ—Ç–æ–≤—ã –∫ —Ä–∞–∑–Ω—ã–º —Å–æ–±—ã—Ç–∏—è–º")

            # –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Å–∏–ª–µ –∞—Å–ø–µ–∫—Ç–æ–≤
            if strong_aspects >= 3:
                general_recs.append("üí• –ù–µ—Å–∫–æ–ª—å–∫–æ —Å–∏–ª—å–Ω—ã—Ö –∞—Å–ø–µ–∫—Ç–æ–≤ - –≤–∞–∂–Ω—ã–π –¥–µ–Ω—å –¥–ª—è —Ä–µ—à–µ–Ω–∏–π –∏ –¥–µ–π—Å—Ç–≤–∏–π")
            elif strong_aspects == 0 and total_aspects > 0:
                general_recs.append("üåä –ê—Å–ø–µ–∫—Ç—ã —Å–ª–∞–±—ã–µ - —Ö–æ—Ä–æ—à–µ–µ –≤—Ä–µ–º—è –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è")

            # –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ä–µ—Ç—Ä–æ–≥—Ä–∞–¥–Ω—ã–º –ø–ª–∞–Ω–µ—Ç–∞–º
            retrograde_planets = self._detect_retrograde_influences(aspects_data)
            if retrograde_planets:
                planet_names = [self.planet_names_ru.get(p, p) for p in retrograde_planets]
                general_recs.append(
                    f"üîÑ –í–ª–∏—è–Ω–∏–µ —Ä–µ—Ç—Ä–æ–≥—Ä–∞–¥–Ω—ã—Ö –ø–ª–∞–Ω–µ—Ç ({', '.join(planet_names)}) - –≤—Ä–µ–º—è –¥–ª—è –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–∞ –∏ –∞–Ω–∞–ª–∏–∑–∞")

        except Exception as e:
            logger.warning(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ–±—â–∏—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π: {e}")

        return general_recs

    def _detect_retrograde_influences(self, aspects_data: List[Dict]) -> List[str]:
        """–û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ —Ä–µ—Ç—Ä–æ–≥—Ä–∞–¥–Ω—ã—Ö –≤–ª–∏—è–Ω–∏–π –≤ –∞—Å–ø–µ–∫—Ç–∞—Ö"""
        retrograde_planets = set()

        for aspect in aspects_data:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç—Ä–∞–Ω–∑–∏—Ç–Ω—ã–µ –ø–ª–∞–Ω–µ—Ç—ã –Ω–∞ —Ä–µ—Ç—Ä–æ–≥—Ä–∞–¥–Ω–æ—Å—Ç—å
            if aspect.get('transit_planet') in ['Mercury', 'Venus', 'Mars', 'Jupiter', 'Saturn', 'Uranus', 'Neptune',
                                                'Pluto']:
                # –í —Ä–µ–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ –∑–¥–µ—Å—å –±—ã–ª–∞ –±—ã –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ä–µ—Ç—Ä–æ–≥—Ä–∞–¥–Ω–æ—Å—Ç—å
                # –°–µ–π—á–∞—Å –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
                if random.random() < 0.3:  # 30% —à–∞–Ω—Å —á—Ç–æ –ø–ª–∞–Ω–µ—Ç–∞ —Ä–µ—Ç—Ä–æ–≥—Ä–∞–¥–Ω–∞—è
                    retrograde_planets.add(aspect['transit_planet'])

        return list(retrograde_planets)


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –¥–≤–∏–∂–∫–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
aspect_recommendations = AspectRecommendationEngine()